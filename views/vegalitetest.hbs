<h2> This page is a test for how vega lite works in web pages. </h2>

<!-- Dependencies for vega lite. -->
<script src="https://cdn.jsdelivr.net/npm/vega@5.22.1"></script>
<script src="https://cdn.jsdelivr.net/npm/vega-lite@5.5.0"></script>
<script src="https://cdn.jsdelivr.net/npm/vega-embed@6.21.0"></script>

<!-- Container for the visualization -->
<div id="sunburst"></div>
<div id="rightside"></div>
<!-- Script for the visualization specification. --> 
<script type="module">
  import axios from 'https://cdn.skypack.dev/axios';
  // Assign the specification to a local variable vlSpec.
  var sunburst = {
  "$schema": "https://vega.github.io/schema/vega/v5.json",
  "description": "An example of a space-fulling radial layout for hierarchical data.",
  "width": 1000,
  "height": 1000,
  "padding": 0,
  "autosize": "none",

  "data": [
    {
      "name": "tree",
      "values": [

          {"size": 27.2583,"id": "000000", "parent":null, "name":"I alt", "andel": 100},

          {"size": 0, "id": "010000", "parent":"000000",  "name":"Fødevarer og ikke alkoholiske drikkevarer", "andel": 12.5779},

          {"size": 0, "id": "011000", "parent":"010000",  "name":"Fødevarer", "andel": 11.025},

          {"size": 0, "id": "011100", "parent":"011000",  "name":"Brød og kornprodukter" , "andel": 1.595},
          {"size": 0.0605, "id": "011110", "parent":"011100",  "name":"Ris","andel": 0.0605},
          {"size": 0.0465, "id": "011120", "parent":"011100",  "name":"Mel og gryn", "andel": 0.0465},
          {"size": 0.6454, "id": "011130", "parent":"011100",  "name":"Brød"},
          {"size": 0.4726, "id": "011140", "parent":"011100",  "name":"Andet bagværk"},
          {"size": 0.0624, "id": "011150", "parent":"011100",  "name":"Pizza og tærter"},
          {"size": 0.1201, "id": "011160", "parent":"011100",  "name":"Pastaprodukter og couscous"},
          {"size": 0.1357, "id": "011170", "parent":"011100",  "name":"Morgenmadsprodukter"},
          {"size": 0.0518, "id": "011180", "parent":"011100",  "name":"Blandingsmel og færdigdej"},

          {"size": 0, "id": "011200", "parent":"011000",  "name":"Kød", "andel": 2.5242},
          {"size": 0.6555, "id": "011210", "parent":"011200",  "name":"Okse- og kalvekød"},
          {"size": 0.3361, "id": "011220", "parent":"011200",  "name":"Svinekød"},
          {"size": 0.0474, "id": "011230", "parent":"011200",  "name":"Lamme- og gedekød"},
          {"size": 0.4297, "id": "011240", "parent":"011200",  "name":"Fjerkræ"},
          {"size": 0.0079, "id": "011260", "parent":"011200",  "name":"Indmad o.l."},
          {"size": 0.526, "id": "011270", "parent":"011200",  "name":"Tørret, saltet eller røget kød "},
          {"size": 0.5216, "id": "011280", "parent":"011200",  "name":"Andet kødpålæg mv."},

          {"size": 0, "id": "011300", "parent":"011000",  "name":"Fisk og skaldyr","andel": 2.4741},
          {"size": 0.1174, "id": "011310", "parent":"011300",  "name":"Fisk, fersk"},
          {"size": 0.0267, "id": "011320", "parent":"011300",  "name":"Fisk, frossen"},
          {"size": 0.0418, "id": "011340", "parent":"011300",  "name":"Skaldyr, frossen"},
          {"size": 0.0781, "id": "011350", "parent":"011300",  "name":"Tørrede, røgede eller saltede fisk og skaldyr"},
          {"size": 0.2101, "id": "011360", "parent":"011300",  "name":"Andre konserverede eller forarbejdede fisk og skaldyr"},

          {"size": 0, "id": "011400", "parent":"011000",  "name":"Mælk, ost og æg","andel": 1.7458},
          {"size": 0.1691, "id": "011410", "parent":"011400",  "name":"Mælk, frisk"},
          {"size": 0.2465, "id": "011420", "parent":"011400",  "name":"Mælk med lavt fedtindhold, frisk"},
          {"size": 0.2379, "id": "011440", "parent":"011400",  "name":"Yoghurt"},
          {"size": 0.6339, "id": "011450", "parent":"011400",  "name":"Ost"},
          {"size": 0.263, "id": "011460", "parent":"011400",  "name":"Andre mejeriprodukter"},
          {"size": 0.1954, "id": "011470", "parent":"011400",  "name":"Æg"},

          {"size": 0, "id": "011500", "parent":"011000",  "name":"Smør, margarine og spiseolier", "andel": 0.3501},
          {"size": 0.2036, "id": "011510", "parent":"011500",  "name":"Smør"},
          {"size": 0.0508, "id": "011520", "parent":"011500",  "name":"Margarine og andre vegetabilske fedtstoffer"},
          {"size": 0.0566, "id": "011530", "parent":"011500",  "name":"Olivenolie"},
          {"size": 0.0391, "id": "011540", "parent":"011500",  "name":"Andre spiseolier"},

          {"size": 0, "id": "011600", "parent":"011000",  "name":"Frugt", "andel": 0.861},
          {"size": 0.5869, "id": "011610", "parent":"011600",  "name":"Frugt, frisk"},
          {"size": 0.0215, "id": "011620", "parent":"011600",  "name":"Frugt, frossen"},
          {"size": 0.195, "id": "011630", "parent":"011600",  "name":"Tørrede frugter og nødder"},
          {"size": 0.0576, "id": "011640", "parent":"011600",  "name":"Konserverede frugter, frugtbaserede produkter"},

          {"size": 0, "id": "011700", "parent":"011000",  "name":"Grøntsager" ,"andel": 1.2233},
          {"size": 0.6832, "id": "011710", "parent":"011700",  "name":"Grøntsager ekskl. kartofler, frisk"},
          {"size": 0.0579, "id": "011720", "parent":"011700",  "name":"Grøntsager, frosne"},
          {"size": 0.1978, "id": "011730", "parent":"011700",  "name":"Tørrede eller forarbejdede grøntsager"},
          {"size": 0.1755, "id": "011740", "parent":"011700",  "name":"Kartofler og kartoffelprodukter"},
          {"size": 0.109, "id": "011750", "parent":"011700",  "name":"Chips mv."},

          {"size": 0, "id": "011800", "parent":"011000",  "name":"Sukkervarer, marmelade, chokolade mv.","andel": 1.6951},
          {"size": 0.056, "id": "011810", "parent":"011800",  "name":"Sukker o.l."},
          {"size": 0.1271, "id": "011820", "parent":"011800",  "name":"Syltetøj, marmelade og honning"},
          {"size": 0.5117, "id": "011830", "parent":"011800",  "name":"Chokolade"},
          {"size": 0.6024, "id": "011840", "parent":"011800",  "name":"Slik og marcipan"},
          {"size": 0.3978, "id": "011850", "parent":"011800",  "name":"Konsumis"},

          {"size": 0, "id": "011900", "parent":"011000",  "name":"Andre fødevarer","andel": 0.5563},
          {"size": 0.1812, "id": "011910", "parent":"011900",  "name":"Sovs og andre smagspræparater"},
          {"size": 0.091, "id": "011920", "parent":"011900",  "name":"Salt, krydderier og krydderurter "},
          {"size": 0.0334, "id": "011930", "parent":"011900",  "name":"Babymad"},
          {"size": 0.204, "id": "011940", "parent":"011900",  "name":"Færdigretter"},
          {"size": 0.0468, "id": "011990", "parent":"011900",  "name":"Andre fødevarer"},

          {"size": 0, "id": "012000", "parent":"010000",  "name":"Ikke-alkoholiske drikkevarer" ,"andel": 1.553},
          {"size": 0, "id": "012100", "parent":"012000",  "name":"Kaffe, te og kakao"},
          {"size": 0.3614, "id": "012110", "parent":"012100",  "name":"Kaffe"},
          {"size": 0.0885, "id": "012120", "parent":"012100",  "name":"Te"},
          {"size": 0.01, "id": "012130", "parent":"012100",  "name":"Kakao"},
          {"size": 0, "id": "012200", "parent":"012000",  "name":"Mineralvand, sodavand og juice"},
          {"size": 0.1195, "id": "012210", "parent":"012200",  "name":"Mineralvand eller kildevand"},
          {"size": 0.6012, "id": "012220", "parent":"012200",  "name":"Læskedrikke"},
          {"size": 0.3724, "id": "012230", "parent":"012200",  "name":"Frugt- og grøntsagssaft samt koncentrater til saft"},

          {"size": 0, "id": "020000", "parent":"000000",  "name":"ALKOHOLISKE DRIKKEVARER OG TOBAK", "andel": 4.2698},
          {"size": 0, "id": "021000", "parent":"020000",  "name":"Alkoholiske drikkevarer", "andel": 1.9728},
          {"size": 0, "id": "021100", "parent":"021000",  "name":"Spiritus", "andel": 0.2526},
          {"size": 0.2365, "id": "021110", "parent":"021100",  "name":"Spiritus og likør"},
          {"size": 0.0161, "id": "021120", "parent":"021100",  "name":"Alkoholiske læskedrikke"},
          {"size": 0, "id": "021200", "parent":"021000",  "name":"Vin", "andel": 1.0412},
          {"size": 1.0412, "id": "021210", "parent":"021200",  "name":"Vin af druer"},
          {"size": 0.0136, "id": "021220", "parent":"021200",  "name":"Vin af andre frugter"},
          {"size": 0.0552, "id": "021230", "parent":"021200",  "name":"Hedvin"},
          {"size": 0, "id": "021300", "parent":"021000",  "name":"Øl", "andel": 0.6103},
          {"size": 0.594, "id": "021310", "parent":"021300",  "name":"Pilsnerøl, guldøl"},
          {"size": 0.0162, "id": "021330", "parent":"021300",  "name":"Øl med lavt alkoholindhold og alkoholfri øl (under 1 pct.alk.)"},
          {"size": 0, "id": "022000", "parent":"020000",  "name":"Tobak", "andel": 2.2969},
          {"size": 1.8699, "id": "022010", "parent":"022000",  "name":"Cigaretter"},
          {"size": 0.048, "id": "022020", "parent":"022000",  "name":"Cigarer o.l."},
          {"size": 0.379, "id": "022030", "parent":"022000",  "name":"Andre tobaksvarer"},

          {"size": 0, "id": "030000", "parent":"000000",  "name":"BEKLÆDNING OG FODTØJ", "andel": 4.5817},
          {"size": 0, "id": "031000", "parent":"030000",  "name":"Beklædning"},
          {"size": 0.0373, "id": "031100", "parent":"031000",  "name":"Beklædningstekstiler"},

          {"size": 0, "id": "031200", "parent":"031000",  "name":"Beklædningsartikler", "andel": 3.2044},
          {"size": 1.0778, "id": "031210", "parent":"031200",  "name":"Tøj til mænd"},
          {"size": 1.6905, "id": "031220", "parent":"031200",  "name":"Tøj til kvinder"},
          {"size": 0.4361, "id": "031230", "parent":"031200",  "name":"Tøj til børn under 14 år"},

          {"size": 0, "id": "031300", "parent":"031000",  "name":"Andre artikler til beklædning", "andel": 0.281},
          {"size": 0.1609, "id": "031310", "parent":"031300",  "name":"Andre beklædningsgenstande"},
          {"size": 0.1201, "id": "031320", "parent":"031300",  "name":"Beklædningstilbehør"},
          {"size": 0.0298, "id": "031400", "parent":"031000",  "name":"Rensning, reparation og leje af beklædning"},
          {"size": 1.0292, "id": "032000", "parent":"030000",  "name":"Fodtøj"},

          {"size": 0, "id": "040000", "parent":"000000",  "name":"BOLIGBENYTTELSE, ELEKTRICITET OG OPVARMNING", "andel": 29.9251},

          {"size": 8.2186, "id": "041000", "parent":"040000",  "name":"Faktisk husleje"},
          {"size": 12.8423, "id": "042000", "parent":"040000",  "name":"Beregnet lejeværdi af bolig"},

          {"size": 0, "id": "043000", "parent":"040000",  "name":"Vedligeholdelse og reparation af bolig", "andel": 1.2416 },
          {"size": 0.6724, "id": "043100", "parent":"043000",  "name":"Materialer til vedligeholdelse og reparation af bolig"},
          {"size": 0.5692, "id": "043200", "parent":"043000",  "name":"Tjenester til vedligeholdelse og reparation af bolig"},

          {"size": 2.2391, "id": "044000", "parent":"040000",  "name":"Vandforsyning og andre tjenester i forbindelse med boligen"},

          {"size": 0, "id": "045000", "parent":"040000",  "name":"Elektricitet, gas og andet brændsel", "andel":5.3835},
          {"size": 2.5475, "id": "045100", "parent":"045000",  "name":"Elektricitet"},

          {"size": 0, "id": "045200", "parent":"045000",  "name":"Gas", "andel":0.6485},
          {"size": 0.6146, "id": "045210", "parent":"045200",  "name":"Naturgas o.l."},
          {"size": 0.0339, "id": "045220", "parent":"045200",  "name":"Flaskegas"},
          {"size": 0.2313, "id": "045300", "parent":"045000",  "name":"Flydende brændsel"},
          {"size": 0.2596, "id": "045400", "parent":"045000",  "name":"Fast brændsel"},
          {"size": 1.6965, "id": "045500", "parent":"045000",  "name":"Fjernvarme mv."},

          {"size": 0.7568, "id": "050000", "parent":"000000",  "name":"MØBLER, HUSHOLDNINGSUDSTYR OG HUSHOLDNINGSTJENESTER", "andel":6.4012},

          {"size": 0, "id": "051000", "parent":"050000",  "name":"Møbler og boligudstyr, tæpper og anden gulvbelægning", "andel":2.5985},

          {"size": 0, "id": "051100", "parent":"051000",  "name":"Møbler og boligudstyr", "andel":2.4213},
          {"size": 1.5476, "id": "051110", "parent":"051100",  "name":"Møbler"},
          {"size": 0.2176, "id": "051120", "parent":"051100",  "name":"Havemøbler"},

          {"size": 0.1593, "id": "051200", "parent":"051000",  "name":"Tæpper og anden gulvbelægning"},
          {"size": 0.018, "id": "051300", "parent":"051000",  "name":"Reparation af møbler, boligudstyr og gulvbelægning"},

          {"size": 0.6533, "id": "052000", "parent":"050000",  "name":"Boligtekstiler"},

          {"size": 1.0086, "id": "053000", "parent":"050000",  "name":"Husholdningsapparater og reparation heraf"},

          {"size": 0.6382, "id": "054000", "parent":"050000",  "name":"Glas, service og husholdningsredskaber"},
          
          {"size": 0.7458, "id": "055000", "parent":"050000",  "name":"Værktøj og udstyr til hus og have "},

          {"size": 0.4207, "id": "060000", "parent":"000000",  "name":"SUNDHED"},

          {"size": 1.4573, "id": "061000", "parent":"060000",  "name":"Medicinske produkter og udstyr"},

          {"size": 0.4976, "id": "062000", "parent":"060000",  "name":"Ambulant behandling", "andel":1.289 },
          {"size": 0.7914, "id": "062200", "parent":"062000",  "name":"Tandlæge"},

          {"size": 0, "id": "070000", "parent":"000000",  "name":"TRANSPORT","andel":11.819},

          {"size": 4.5816, "id": "071000", "parent":"070000",  "name":"Køb af køretøjer"},

          {"size": 4.0945, "id": "072000", "parent":"070000",  "name":"Drift af personlige transportmidler","andel":6.4804},
          {"size": 2.3859, "id": "072200", "parent":"072000",  "name":"Brændstof"},

          {"size": 0.757, "id": "073000", "parent":"070000",  "name":"Transporttjenester"},

          {"size": 1.9484, "id": "080000", "parent":"000000",  "name":"KOMMUNIKATION"},
          {"size": 10.6246, "id": "090000", "parent":"000000",  "name":"FRITID OG KULTUR"},
          {"size": 0.9222, "id": "100000", "parent":"000000",  "name":"UDDANNELSE"},
          {"size": 5.0053, "id": "110000", "parent":"000000",  "name":"RESTAURANTER OG HOTELLER"},

        ],
        

      "transform": [
        {
          "type": "stratify",
          "key": "id",
          "parentKey": "parent"
        },
        {
          "type": "partition",
          "field": "size",
          "size": [{"signal": "2 * PI"}, {"signal": "width/2"}],
          "as": ["a0", "r0", "a1", "r1", "depth", "children"]
        }
      ]
    }
  ],

  "scales": [
    {
      "name": "color",
      
      "type": "linear",
      "domain": {"data": "tree", "field": "id"},
      
      "range": {"scheme": "tableau20"}
      
    }
  ],

  "marks": [
    {
      "type": "arc",
      "from": {"data": "tree"},
      "encode": {
        
        "enter": {
          "x": {"signal": "width / 2"},
          "y": {"signal": "height /2"},

          "fill": {"scale": "color", "field": "id"},
          "tooltip": {"signal": "datum.name + ' ' +  (datum.andel?  datum.andel:datum.size) + '%'"}
        },
        "update": {
          "startAngle": {"field": "a0"},
          "endAngle": {"field": "a1"},
          "innerRadius": {"field": "r0"},
          "outerRadius": {"field": "r1"},
          "stroke": {"value": "white"},
          "strokeWidth": {"value": 0.2},
          "zindex": {"value": 0}
        },
        "hover": {
          "stroke": {"value": "red"},
          "strokeWidth": {"value": 2},
          "zindex": {"value": 1}
        }
      }
    },
    {
      "type": "text",
      "from": {"data": "tree"},
      "encode": {
        "enter": {
          "text": {"field": "name"},
          "fontSize": { "signal": "(datum.a1-datum.a0)*10>1? min((datum.a1-datum.a0)*10,height/20):0" },
          "baseline": {"value": "middle"},
          "limit": { "signal": "(datum.r1-datum.r0)*0.9" },
          "align": {"value": "center"}
        },
        "update": {
          "x": {"signal": "width / 2"},
          "y": {"signal": "height / 2"},
          "limit": { "signal": "(datum.r1-datum.r0)*0.9" },
          "radius": {
            "signal": "(datum['r0'] == 0 ? 0 : datum['r0'] + datum['r1']) / 2"
          },
          "theta": {"signal": "(datum['a0'] + datum['a1']) / 2"},
          "angle": {
            "signal": "datum['r0'] == 0 ? 0 : ((datum['a0'] + datum['a1']) / 2) * 180 / PI + (inrange(((datum['a0'] + datum['a1']) / 2) % (2 * PI), [0, PI]) ? 270 : 90)"
          },
          "tooltip": {
            "signal": "datum.name + (datum.size ? ', ' + datum.size + ' bytes' : '')"
          }
        }
      }
    }
  ]
}
;
function csvToArray(str, delimiter = ";") {
  const headers = str.slice(0, str.indexOf("\n")).split(delimiter);
  const rows = str.slice(str.indexOf("\n") + 1).split("\n");
  const arr = rows.map(function (row) {
    const values = row.split(delimiter);
    const el = headers.reduce(function (object, header, index) {
      object[header] = values[index];
      return object;
    }, {});
    return el;
  });
  return arr;
}

    function fetchData(slectedTabel,VareGR){
    return axios.post("https://api.statbank.dk/v1/data", {
   "table": slectedTabel,
   "format": "CSV",
   "variables": [
      {
         "code": "ENHED",
         "values": [
            "100"
         ]
      },
      {
         "code": "TID",
         "values": [
            "*"
         ]
      },
      {
         "code": "VareGR",
         "values": [
            VareGR
         ]
      }
   ]
    })
  .then(function (response) {
    return response
    
  })
   
  }

  function twoArrayToVegaObjects(labels,data){
    const zip = (a, b) => Array.from(Array(Math.max(b.length, a.length)), (_, i) => [a[i],b[i]])
    const Unlabeleddata = zip(labels,data)
    var labeledData = []
    Unlabeleddata.forEach((aData) => {
        labeledData.push({tid : aData[0], amount : aData[1]})
    })
    return labeledData
   }


  function tidTilVegaTid(oldTid){
    return 
  }

  function buildSecond(table){
     console.log("creating table for " + table)
     const FetchDataPromisePris111 = new Promise((value) => {value(fetchData("PRIS111","000000"))})
     FetchDataPromisePris111.then((value) => {console.log("value")
     const data = csvToArray(value.data)
     
     var tid= []
     var indhold= [] 
     data.forEach(item => {
        if (item["INDHOLD\r"]!=undefined){
          indhold.push(item["INDHOLD\r"].replace("\r","").replace(",","."))
          tid.push(item["TID"].replace("M","-"))
        }
        
     }
     ) 
    var WaterFallData = twoArrayToVegaObjects(tid,indhold)
    
    console.log(WaterFallData)

    //create vega vis from WaterFallData here

    //vegaEmbed('#rightside', rightSide)
     
    }
  )
  }
  // Embed the visualization in the container with id `vis`
  vegaEmbed('#sunburst', sunburst).then(({spec, view}) => {
    view.addEventListener('mousedown', function (event, item) {
        console.log(item.datum.id)
        buildSecond(item.datum.id)
    })
  buildSecond("000000")
})

</script>